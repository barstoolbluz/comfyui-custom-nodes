## Flox Environment Manifest -----------------------------------------
##
##   _Everything_ you need to know about the _manifest_ is here:
##
##   https://flox.dev/docs/reference/command-reference/manifest.toml/
##
## -------------------------------------------------------------------
# Flox manifest version managed by Flox CLI
version = 1


## Install Packages --------------------------------------------------
##  $ flox install gum  <- puts a package in [install] section below
##  $ flox search gum   <- search for a package
##  $ flox show gum     <- show all versions of a package
## -------------------------------------------------------------------
[install]
"barstoolbluz/comfyui-cuda".pkg-path = "barstoolbluz/comfyui-cuda"
"barstoolbluz/comfyui-cuda".systems = ["x86_64-linux"]
"barstoolbluz/comfyui-cuda".pkg-group = "barstoolbluz/comfyui-cuda"
"barstoolbluz/torchaudio-python313-cuda12_8-sm120-avx512".pkg-path = "barstoolbluz/torchaudio-python313-cuda12_8-sm120-avx512"
"barstoolbluz/torchaudio-python313-cuda12_8-sm120-avx512".systems = ["x86_64-linux"]
"barstoolbluz/torchaudio-python313-cuda12_8-sm120-avx512".pkg-group = "barstoolbluz/torchaudio-python313-cuda12_8-sm120-avx512"
"barstoolbluz/pytorch-python313-cuda12_8-sm120-avx512".pkg-path = "barstoolbluz/pytorch-python313-cuda12_8-sm120-avx512"
"barstoolbluz/pytorch-python313-cuda12_8-sm120-avx512".systems = ["x86_64-linux"]
"barstoolbluz/pytorch-python313-cuda12_8-sm120-avx512".pkg-group = "barstoolbluz/pytorch-python313-cuda12_8-sm120-avx512"
"barstoolbluz/torchvision-python313-cuda12_8-sm120-avx512".pkg-path = "barstoolbluz/torchvision-python313-cuda12_8-sm120-avx512"
"barstoolbluz/torchvision-python313-cuda12_8-sm120-avx512".systems = ["x86_64-linux"]
"barstoolbluz/torchvision-python313-cuda12_8-sm120-avx512".pkg-group = "barstoolbluz/torchvision-python313-cuda12_8-sm120-avx512"
opencv4.pkg-path = "python313Packages.opencv4"
matplotlib.pkg-path = "python313Packages.matplotlib"
mss.pkg-path = "python313Packages.mss"
piexif.pkg-path = "python313Packages.piexif"
numba.pkg-path = "python313Packages.numba"
scikit-image.pkg-path = "python313Packages.scikit-image"
scikit-learn.pkg-path = "python313Packages.scikit-learn"
imageio.pkg-path = "python313Packages.imageio"
joblib.pkg-path = "python313Packages.joblib"
# gum.pkg-path = "gum"
# gum.version = "^0.14.5"

# Local Nix-built packages
comfyui-tools.pkg-path = "comfyui-tools"
comfyui-custom-nodes.pkg-path = "comfyui-custom-nodes"


## Environment Variables ---------------------------------------------
##  ... available for use in the activated environment
##      as well as [hook], [profile] scripts and [services] below.
## -------------------------------------------------------------------
[vars]
# ComfyUI directories
COMFYUI_WORK_DIR = "$HOME/comfyui-work"
COMFYUI_USER_DIR = "$HOME/comfyui-work"
COMFYUI_OUTPUT_DIR = "$HOME/comfyui-work/output"
COMFYUI_INPUT_DIR = "$HOME/comfyui-work/input"
COMFYUI_TEMP_DIR = "$HOME/comfyui-work/temp"
COMFYUI_MODELS_DIR = "$HOME/comfyui-work/models"

# ComfyUI database (stored in environment cache)
COMFYUI_DATABASE_URL = "sqlite:///${FLOX_ENV_CACHE:-$HOME/.flox/cache}/comfyui.db"

# ComfyUI network settings
COMFYUI_HOST = "0.0.0.0"
COMFYUI_PORT = "8188"


## Activation Hook ---------------------------------------------------
##  ... run by _bash_ shell when you run 'flox activate'.
## -------------------------------------------------------------------
[hook]
on-activate = '''
  # Create ComfyUI working directories
  mkdir -p "$COMFYUI_WORK_DIR"/{models,output,input,temp,custom_nodes}

  # Create log directory for service
  mkdir -p "$FLOX_ENV_CACHE/logs"

  # Setup custom nodes on first activation
  SETUP_MARKER="$FLOX_ENV_CACHE/.custom_nodes_setup_complete"
  if [ ! -f "$SETUP_MARKER" ]; then
    echo "ðŸ”§ First-time setup: Installing custom nodes..."
    # Try package location first, then fall back to project directory
    if [ -f "$FLOX_ENV/share/comfyui-custom-nodes/setup-custom-nodes.sh" ]; then
      bash "$FLOX_ENV/share/comfyui-custom-nodes/setup-custom-nodes.sh"
      touch "$SETUP_MARKER"
      echo "âœ… Custom nodes setup complete!"
    elif [ -f "$FLOX_ENV_PROJECT/setup-custom-nodes.sh" ]; then
      bash "$FLOX_ENV_PROJECT/setup-custom-nodes.sh"
      touch "$SETUP_MARKER"
      echo "âœ… Custom nodes setup complete!"
    else
      echo "âš ï¸  setup-custom-nodes.sh not found, skipping custom nodes installation"
    fi
  fi

  echo "âœ… ComfyUI directories ready at: $COMFYUI_WORK_DIR"
  echo "   Use 'flox services start comfyui' to start the server"
  echo "   Or 'flox activate --start-services' to auto-start"
'''


## Profile script ----------------------------------------------------
## ... sourced by _your shell_ when you run 'flox activate'.
## -------------------------------------------------------------------
[profile]
# common = '''
#   gum style \
#   --foreground 212 --border-foreground 212 --border double \
#   --align center --width 50 --margin "1 2" --padding "2 4" \
#     $INTRO_MESSAGE
# '''
## Shell-specific customizations such as setting aliases go here:
# bash = ...
# zsh  = ...
# fish = ...


## Services ---------------------------------------------------------
##  $ flox services start             <- Starts all services
##  $ flox services status            <- Status of running services
##  $ flox activate --start-services  <- Activates & starts all
## ------------------------------------------------------------------
[services]
[services.comfyui]
command = '''
  exec comfyui-cuda \
    --user-directory "$COMFYUI_USER_DIR" \
    --output-directory "$COMFYUI_OUTPUT_DIR" \
    --temp-directory "$COMFYUI_TEMP_DIR" \
    --input-directory "$COMFYUI_INPUT_DIR" \
    --extra-model-paths-config /home/daedalus/comfyui-work/extra_model_paths.yaml \
    --database-url "$COMFYUI_DATABASE_URL" \
    --listen "$COMFYUI_HOST" \
    --port "$COMFYUI_PORT" \
    2>&1 | tee -a "$FLOX_ENV_CACHE/logs/comfyui.log"
'''
is-daemon = true

[services.comfyui.shutdown]
command = "kill $FLOX_PROCESS_PID"


## Include ----------------------------------------------------------
## ... environments to create a composed environment
## ------------------------------------------------------------------
[include]
# environments = [
#     { dir = "../common" }
# ]


## Build and publish your own packages ------------------------------
##  $ flox build
##  $ flox publish
##
##  Build definitions have been moved to Nix expressions in .flox/pkgs/
##  - comfyui-tools.nix
##  - comfyui-custom-nodes.nix
## ------------------------------------------------------------------


## Other Environment Options -----------------------------------------
[options]
# Systems that environment is compatible with
# systems = [
#   "aarch64-darwin",
#   "aarch64-linux",
#   "x86_64-darwin",
#   "x86_64-linux",
# ]
# Uncomment to disable CUDA detection.
# cuda-detection = false
